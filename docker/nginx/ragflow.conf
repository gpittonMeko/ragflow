server {
listen 80;
server_name sgailegal.com sgailegal.it www.sgailegal.com www.sgailegal.it;
return 301 https://$host$request_uri;
}


server {
listen 443 ssl;
server_name sgailegal.com sgailegal.it www.sgailegal.com www.sgailegal.it;

# React build
root /ragflow/web/dist;

# TLS (Let’s Encrypt)
ssl_certificate     /etc/letsencrypt/live/sgailegal.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/sgailegal.com/privkey.pem;

# --------------------------------------------------------------
#  GZIP
# --------------------------------------------------------------
gzip on;
gzip_min_length 1k;
gzip_comp_level 6;
gzip_types text/plain application/javascript text/css application/json image/svg+xml image/png image/jpeg;

# --------------------------------------------------------------
#  BACKEND – Ragflow  (porta 9380 nel container)
# --------------------------------------------------------------
location ^~ /api/  { include /etc/nginx/proxy.conf; proxy_pass http://127.0.0.1:9380; }
location ^~ /v1/   { include /etc/nginx/proxy.conf; proxy_pass http://127.0.0.1:9380; }

# --------------------------------------------------------------
#  BACKEND – Chat (stream SSE / WebSocket)  → Ragflow (9380)
# --------------------------------------------------------------
location ^~ /chat/ {
    include /etc/nginx/proxy.conf;
    proxy_buffering off;                 # importante per SSE / stream lunghi
    proxy_http_version 1.1;              # ok anche per eventuale WS
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_pass http://127.0.0.1:9380;    #  <-- NIENTE slash finale = path invariato
}

# --------------------------------------------------------------
#  BACKEND – OAuth Flask  (porta 8000 nel container)
#  Il prefisso /oauth/ DEVE arrivare al backend ⇒ niente slash finale
# --------------------------------------------------------------
location ^~ /oauth/ {
    include /etc/nginx/proxy.conf;
    proxy_redirect off;
    proxy_pass http://127.0.0.1:8000;
}

# --------------------------------------------------------------
#  SPA React (HTML sulla root)a
# --------------------------------------------------------------
location / {
    index index.html;
    try_files $uri $uri/ /index.html;
}

# --------------------------------------------------------------
#  Asset statici versionati → cache lunghissima
# --------------------------------------------------------------
location ~ ^/static/(css|js|media)/ {
    expires 10y;
    access_log off;
}

# --------------------------------------------------------------
#  NON aggiungere COOP/COEP: parent↔iframe deve potersi parlare
# --------------------------------------------------------------